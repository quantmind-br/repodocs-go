{
  "task_description": "# Plano de Aumento de Cobertura de Testes\n\n**Objetivo:** Aumentar cobertura de testes de 20.2% para no mínimo 80% por pacote.\n\n**Threshold Ajustados:** Alguns pacotes terão thresholds menores devido à complexidade extrema ou dependências externas.\n\n---\n\n## Estado Atual\n\n| Pacote | Cobertura | Status |\n|--------|-----------|--------|\n| pkg/version | 100.0% | ✅ Concluído |\n| internal/utils | 94.3% | ✅ Concluído |\n| internal/strategies | 31.0% | ⚠️ Precisa de trabalho |\n| internal/llm | 6.0% | ❌ Crítico |\n| cmd/repodocs | 0.0% | ❌ Sem testes |\n| internal/app | 0.0% | ❌ Sem testes |\n| internal/cache | 0.0% | ❌ Sem testes |\n| internal/config | 0.0% | ❌ Sem testes |\n| internal/converter | 0.0% | ❌ Crítico |\n| internal/domain | 0.0% | ❌ Sem testes |\n| internal/fetcher | 0.0% | ❌ Alta complexidade |\n| internal/git | 0.0% | ❌ Sem testes |\n| internal/output | 0.0% | ❌ Sem testes |\n| internal/renderer | 0.0% | ❌ Muito alta complexidade (40-50%) |\n\n---\n\n## Estratégia de Testes\n\n### Abordagem Híbrida (para pacotes de alta complexidade)\n- **Testes de Unidade**: Usar mocks para testes rápidos e isolados\n- **Testes de Integração Selecionados**: Para casos críticos com dependências reais\n- **Testes de Contrato**: Verificar conformidade com interfaces\n\n### Infraestrutura Disponível\n- Test utilities: `tests/testutil/` (temp dirs, cache, HTTP servers, assertions)\n- Mocks: `tests/mocks/` (gerados com go.uber.org/mock)\n- Fixtures: `tests/fixtures/`, `tests/testdata/fixtures/`\n\n---\n\n## Fases de Implementação (Criticidade Primeiro)\n\n### FASE 1: Componentes Críticos de Negócio\n**Meta:** Cobertura 80%+ | Estimativa: 3-4 semanas\n\n#### 1.1 internal/strategies (31% → 85%)\n**Arquivos a criar:**\n- `tests/unit/strategies/git_strategy_test.go` - Testes de unidade para GitStrategy\n- `tests/unit/strategies/crawler_strategy_test.go` - Expandir cobertura existente\n- `tests/unit/strategies/llms_strategy_test.go` - Testes completos para LLMS\n- `tests/unit/strategies/pkggo_strategy_test.go` - Expandir cobertura existente\n- `tests/unit/strategies/strategy_base_test.go` - Testes para métodos base\n\n**Funções a cobrir:**\n- Git: `parseGitURL`, `tryArchiveDownload`, `downloadAndExtract`, `extractTarGz`, `findDocumentationFiles`, `processFiles`, `processFile`, `detectDefaultBranch`\n- Crawler: `Execute`, `isHTMLContentType`, `crawling logic`\n- LLMS: `Execute`, `parseLLMSLinks`, `filterLLMSLinks`\n- PkgGo: `Execute`, `extractSections`\n- Base: `DefaultOptions`, `FlushMetadata`, `SetStrategy`, `SetSourceURL`, `WriteDocument`\n\n**Mocks necessários:** Expandir mocks para GitClient, HTTP responses\n\n#### 1.2 internal/converter (0% → 85%)\n**Arquivos a criar:**\n- `tests/unit/converter/pipeline_test.go` - Pipeline orchestration\n- `tests/unit/converter/sanitizer_test.go` - HTML sanitization\n- `tests/unit/converter/readability_test.go` - Content extraction\n- `tests/unit/converter/markdown_test.go` - Markdown conversion\n- `tests/unit/converter/encoding_test.go` - Encoding normalization\n\n**Funções a cobrir:**\n- Pipeline: `Convert`, `ConvertHTML`, `ConvertHTMLWithSelector`, `removeExcluded`\n- Sanitizer: `Sanitize`, `normalizeURLs`, `resolveURL`, `normalizeSrcset`, `removeEmptyElements`\n- Readability: `Extract`, `extractWithSelector`, `extractWithReadability`, `ExtractDescription`, `ExtractHeaders`, `ExtractLinks`\n- Markdown: `Convert`, `cleanMarkdown`, `GenerateFrontmatter`, `AddFrontmatter`, `StripMarkdown`, `CountWords`, `CountChars`\n- Encoding: `DetectEncoding`, `ConvertToUTF8`, `IsUTF8`, `GetEncoder`\n\n**Fixtures necessárias:** HTML samples com diversos cenários (SPA, tabelas, code blocks, etc.)\n\n#### 1.3 internal/app (0% → 85%)\n**Arquivo a criar/modificar:**\n- `tests/unit/app/detector_test.go` - Expandir testes existentes\n- `tests/unit/app/orchestrator_test.go` - Já existe, expandir cobertura\n\n**Funções a cobrir:**\n- Detector: `DetectStrategy`, `CreateStrategy`, `GetAllStrategies`, `FindMatchingStrategy`\n- Orchestrator: `NewOrchestrator`, `Run`, `Close`, `GetStrategyName`, `ValidateURL`\n\n**Mocks necessários:** Strategy factory injection já existe\n\n---\n\n### FASE 2: LLM e Configuração\n**Meta:** Cobertura 80%+ | Estimativa: 2-3 semanas\n\n#### 2.1 internal/llm (6% → 80%)\n**Arquivos a criar:**\n- `tests/unit/llm/provider_test.go` - Provider factory e interfaces\n- `tests/unit/llm/circuit_breaker_test.go` - Circuit breaker state machine\n- `tests/unit/llm/retry_test.go` - Retry logic e backoff\n- `tests/unit/llm/ratelimit_test.go` - Rate limiter com timing controlado\n- `tests/integration/llm/provider_integration_test.go` - Testes de integração com HTTP mocking\n\n**Funções a cobrir:**\n- Providers: `NewAnthropicProvider`, `NewGoogleProvider`, `NewOpenAIProvider`, `Complete`, `Close`, `handleHTTPError`\n- Circuit Breaker: `NewCircuitBreaker`, `Allow`, `RecordSuccess`, `RecordFailure`, `State`, `transitionTo`\n- Retry: `NewRetrier`, `Execute`, `calculateBackoff`, `IsRetryableError`, `ShouldRetryStatusCode`\n- Rate Limiter: `NewTokenBucket`, `Wait`, `TryAcquire`, `Available`, `refill`\n- Metadata: `Enhance`, `EnhanceAll`, `applyMetadata`\n\n**Abordagem:** Unit tests com mocks + integração para HTTP\n\n#### 2.2 internal/config (0% → 85%)\n**Arquivos a criar:**\n- `tests/unit/config/config_test.go` - Config validation\n- `tests/unit/config/loader_test.go` - Config loading com Viper mocking\n- `tests/unit/config/defaults_test.go` - Default values\n\n**Funções a cobrir:**\n- Config: `Validate`, métodos de validação\n- Loader: `Load`, `LoadWithViper`, `setDefaults`, `EnsureConfigDir`, `EnsureCacheDir`\n- Defaults: `Default`, `ConfigDir`, `CacheDir`, `ConfigFilePath`\n\n---\n\n### FASE 3: Output e Cache\n**Meta:** Cobertura 75%+ | Estimativa: 2 semanas\n\n#### 3.1 internal/output (0% → 80%)\n**Arquivos a criar:**\n- `tests/unit/output/writer_test.go` - Writer operations\n- `tests/unit/output/collector_test.go` - MetadataCollector\n\n**Funções a cobrir:**\n- Writer: `Write`, `WriteMultiple`, `FlushMetadata`, `Exists`, `EnsureBaseDir`, `Clean`, `Stats`\n- Collector: `Add`, `Flush`, `buildIndex`, `GetIndex`, métodos de configuração\n\n#### 3.2 internal/cache (0% → 75%)\n**Arquivos a criar:**\n- `tests/unit/cache/badger_test.go` - BadgerCache operations\n- `tests/unit/cache/keys_test.go` - Key generation\n- `tests/integration/cache/cache_integration_test.go` - Cache com BadgerDB real\n\n**Funções a cobrir:**\n- BadgerCache: `NewBadgerCache`, `Get`, `Set`, `Has`, `Delete`, `Close`, `Clear`, `Size`, `Stats`\n- Keys: `GenerateKey`, `GenerateKeyWithPrefix`, `normalizeForKey`, `PageKey`, `SitemapKey`, `MetadataKey`\n\n**Abordagem:** Unit tests com in-memory cache + integração para persistência\n\n---\n\n### FASE 4: Fetcher e Git\n**Meta:** Cobertura 70-75% | Estimativa: 2 semanas\n\n#### 4.1 internal/fetcher (0% → 70%)\n**Arquivos a criar:**\n- `tests/unit/fetcher/client_test.go` - HTTP client operations\n- `tests/unit/fetcher/retry_test.go` - Retry logic\n- `tests/unit/fetcher/stealth_test.go` - Stealth headers\n- `tests/integration/fetcher/fetcher_integration_test.go` - HTTP requests reais\n\n**Funções a cobrir:**\n- Client: `NewClient`, `Get`, `GetWithHeaders`, `doRequest`, `GetCookies`, `Close`, cache operations\n- Retry: `NewRetrier`, `Retry`, `RetryWithValue`, `ShouldRetryStatus`, `ParseRetryAfter`\n- Stealth: `RandomUserAgent`, `RandomAcceptLanguage`, `StealthHeaders`, `RandomDelay`\n- Transport: `NewStealthTransport`, `RoundTrip`\n\n**Abordagem:** Híbrida - mocks para unit tests + integração para HTTP real\n\n#### 4.2 internal/git (0% → 80%)\n**Arquivos a criar:**\n- `tests/unit/git/client_test.go` - Git client wrapper\n\n**Funções a cobrir:**\n- `NewClient`, `PlainCloneContext`\n\n**Abordagem:** Mock de go-git operations\n\n---\n\n### FASE 5: CLI e Domain\n**Meta:** Cobertura 80%+ | Estimativa: 1-2 semanas\n\n#### 5.1 cmd/repodocs (0% → 80%)\n**Arquivos a criar:**\n- `cmd/repodocs/main_test.go` - CLI operations\n\n**Funções a cobrir:**\n- `run`, `initConfig`, `checkInternet`, `checkChrome`, `checkWritePermissions`, `checkCacheDir`\n\n**Abordagem:** Mock de dependencies e testes de CLI\n\n#### 5.2 internal/domain (0% → 85%)\n**Arquivos a criar:**\n- `tests/unit/domain/models_test.go` - Model methods\n- `tests/unit/domain/errors_test.go` - Error types\n\n**Funções a cobrir:**\n- Models: `ToMetadata`, `ToFrontmatter`, `ToDocumentMetadata`, `ToSimpleMetadata`, `ToSimpleDocumentMetadata`\n- Errors: Construtores e métodos de erro para todos os tipos\n\n---\n\n### FASE 6: Renderer (Alta Complexidade)\n**Meta:** Cobertura 40-50% | Estimativa: 2 semanas\n\n#### 6.1 internal/renderer (0% → 45%)\n**Arquivos a criar:**\n- `tests/unit/renderer/detector_test.go` - Framework detection\n- `tests/unit/renderer/pool_test.go` - Tab pool management\n- `tests/integration/renderer/renderer_integration_test.go` - Browser rendering real\n\n**Funções a cobrir (selecionadas):**\n- Detector: `NeedsJSRendering`, `DetectFramework`, `HasDynamicContent`, `hasSPAPattern`\n- Pool: `NewTabPool`, `Acquire`, `Release`, `Close`, `Size`, `MaxSize`\n- Rod: `DefaultRendererOptions`, `IsAvailable`, `GetBrowserPath`, `Close`\n- Stealth: `DefaultStealthOptions`, `StealthPage`\n\n**Threshold reduzido (40-50%) devido a:**\n- Dependência de Chrome/Chromium instalado\n- Operações de browser que difíceis de mockar\n- Timing sensitivity em JavaScript rendering\n\n**Abordagem:** Unit tests para detecção e pool + integração limitada com browser real\n\n---\n\n## Novos Fixtures e Mocks Necessários\n\n### Fixtures\n- `tests/testdata/fixtures/html/` - Amostras HTML variadas\n- `tests/testdata/fixtures/git/` - Repositórios Git de exemplo\n- `tests/testdata/fixtures/sitemap/` - Sitemaps variados\n- `tests/testdata/fixtures/llms/` - Arquivos llms.txt de exemplo\n\n### Mocks a Gerar/Expandir\n```bash\n# Gerar mocks a partir de interfaces\nmockgen -source=internal/git/client.go -destination=tests/mocks/git.go\nmockgen -source=internal/domain/interfaces.go -destination=tests/mocks/domain.go\n```\n\n---\n\n## Testes de Integração Adicionais\n\n### tests/integration/\n- `converter_integration_test.go` - Pipeline completo\n- `fetcher_integration_test.go` - HTTP requests\n- `cache_integration_test.go` - BadgerDB persistência\n- `strategies_integration_test.go` - Estratégias com dependencies reais\n\n---\n\n## Resumo de Esforço\n\n| Fase | Componentes | Cobertura Alvo | Estimativa |\n|------|-------------|----------------|------------|\n| 1 | strategies, converter, app | 80-85% | 3-4 semanas |\n| 2 | llm, config | 80-85% | 2-3 semanas |\n| 3 | output, cache | 75-80% | 2 semanas |\n| 4 | fetcher, git | 70-80% | 2 semanas |\n| 5 | cmd, domain | 80-85% | 1-2 semanas |\n| 6 | renderer | 40-50% | 2 semanas |\n\n**Total Estimado:** 12-15 semanas\n\n---\n\n## Ajustes de Threshold por Pacote\n\n| Pacote | Threshold | Justificativa |\n|--------|-----------|---------------|\n| internal/renderer | 40-50% | Browser automation, Chrome dependency |\n| internal/fetcher | 70% | Network operations, complex retry logic |\n| internal/cache | 75% | Database persistence, concurrent operations |\n| internal/converter | 85% | HTML processing é testável com fixtures |\n| internal/llm | 80% | HTTP requests podem ser mockados |\n| Demais pacotes | 80%+ | Lógica de negócio principal |\n\n---\n\n## Próximos Passos\n\n1. **Iniciar pela FASE 1** - Componentes críticos de negócio (strategies, converter, app)\n2. **Executar testes incrementalmente** após cada pacote concluído\n3. **Atualizar Makefile** para incluir novos testes\n4. **Configurar CI** para reportar cobertura por pacote\n5. **Documentar** padrões de testes em CONTRIBUTING.md\n\n---\n\n## Arquivos Críticos a Modificar/Criar\n\n### Criar\n- `tests/unit/converter/pipeline_test.go`\n- `tests/unit/converter/sanitizer_test.go`\n- `tests/unit/converter/readability_test.go`\n- `tests/unit/converter/markdown_test.go`\n- `tests/unit/converter/encoding_test.go`\n- `tests/unit/strategies/git_strategy_test.go`\n- `tests/unit/strategies/llms_strategy_test.go`\n- `tests/unit/llm/provider_test.go`\n- `tests/unit/llm/circuit_breaker_test.go`\n- `tests/unit/llm/retry_test.go`\n- `tests/unit/llm/ratelimit_test.go`\n- `tests/unit/config/config_test.go`\n- `tests/unit/output/writer_test.go`\n- `tests/unit/output/collector_test.go`\n- `tests/unit/cache/badger_test.go`\n- `tests/unit/fetcher/client_test.go`\n- `tests/unit/git/client_test.go`\n- `tests/unit/domain/models_test.go`\n- `tests/unit/domain/errors_test.go`\n- `tests/unit/renderer/detector_test.go`\n- `tests/unit/renderer/pool_test.go`\n- `cmd/repodocs/main_test.go`\n\n### Expandir\n- `tests/unit/app/orchestrator_test.go`\n- `tests/unit/strategies/crawler_strategy_test.go`\n- `tests/unit/strategies/pkggo_strategy_test.go`\n- `tests/unit/strategies/sitemap_strategy_test.go`\n\n### Integração\n- `tests/integration/converter_integration_test.go`\n- `tests/integration/fetcher_integration_test.go`\n- `tests/integration/cache_integration_test.go`\n- `tests/integration/llm_integration_test.go`\n- `tests/integration/renderer_integration_test.go`",
  "workflow_type": "feature"
}