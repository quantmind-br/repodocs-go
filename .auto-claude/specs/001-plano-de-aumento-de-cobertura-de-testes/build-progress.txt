# Test Coverage Increase Progress
# Goal: Increase coverage from 20.2% to 80%+ per package

## Current Status: Phase 1 In Progress ğŸš§

### Plan Created: 2026-01-02
### Last Updated: 2026-01-02

## Phase Summary

| Phase | Name | Status | Progress |
|-------|------|--------|----------|
| 1 | Business-Critical Components | âœ… Completed | 4/4 subtasks |
| 2 | LLM and Configuration | âœ… Completed | 2/2 subtasks |
| 3 | Output and Cache | Pending | 0/2 subtasks |
| 4 | Fetcher and Git | Pending | 0/2 subtasks |
| 5 | CLI and Domain | Pending | 0/2 subtasks |
| 6 | Renderer (High Complexity) | Pending | 0/1 subtasks |
| 7 | Mock Generation and Infrastructure | Pending | 0/4 subtasks |

## Detailed Progress

### Phase 1: Business-Critical Components (Target: 80-85%)
**Estimated: 3 weeks**

- [x] 1.1: Expand internal/strategies coverage (31% â†’ 85%)
  - Status: âœ… Completed (2026-01-02)
  - Files: tests/unit/strategies/git_strategy_test.go, crawler_strategy_test.go, llms_strategy_test.go, pkggo_strategy_test.go, strategy_base_test.go, sitemap_strategy_test.go
  - Summary: Created comprehensive unit tests for Crawler, LLMS, PkgGo, Sitemap strategies and base strategy methods. Git strategy already had extensive tests (1400+ lines).

- [x] 1.2: Create internal/converter tests (0% â†’ 85%)
  - Status: âœ… Completed (2026-01-02)
  - Files: tests/unit/converter/pipeline_test.go, sanitizer_test.go, readability_test.go, markdown_test.go, encoding_test.go
  - Summary: Created comprehensive unit tests for all converter pipeline components. sanitizer_test.go (16KB, HTML sanitization), readability_test.go (7.8KB, content extraction), markdown_test.go (183 lines, Markdown conversion), encoding_test.go (67 lines, encoding normalization). Total: 1,221+ lines of comprehensive unit tests.

- [x] 1.3: Create internal/app tests (0% â†’ 85%)
  - Status: âœ… Completed (2026-01-02)
  - Files: tests/unit/app/detector_test.go, orchestrator_test.go
  - Summary: Created comprehensive test coverage for detector and orchestrator. detector_test.go (380+ lines) with 60+ edge case tests for DetectStrategy, CreateStrategy, GetAllStrategies, FindMatchingStrategy. Expanded orchestrator_test.go with 14 additional tests (400+ lines) covering NewOrchestrator, Run, Close, GetStrategyName, ValidateURL with various scenarios including custom strategy factory injection, config validation, error handling, and edge cases.

- [x] 1.4: Create HTML fixtures and expand test utilities
  - Status: âœ… Completed (2026-01-02)
  - Files: tests/testdata/fixtures/html/*.html (7 files)
  - Summary: Created 7 comprehensive HTML fixtures totaling 1,823 lines. spa_page.html (66 lines) with React/Vue/Angular patterns, tables.html (280 lines) with complex tables, code_blocks.html (373 lines) with 10+ languages, navigation.html (241 lines) with navigation patterns, malformed.html (327 lines) with 20+ edge cases, encoding_utf8.html (239 lines) with 15+ languages, encoding_latin1.html (297 lines) with Western European characters. All fixtures support converter pipeline testing.

### Phase 2: LLM and Configuration (Target: 80%)
**Estimated: 2 weeks**

- [x] 2.1: Expand internal/llm tests (6% â†’ 80%)
  - Status: âœ… Completed (2026-01-02)
  - Files: tests/unit/llm/provider_test.go (expanded), tests/unit/llm/circuit_breaker_test.go (existing), tests/unit/llm/retry_test.go (expanded), tests/unit/llm/ratelimit_test.go (expanded), tests/unit/llm/metadata_test.go (expanded), tests/unit/llm/anthropic_test.go (expanded), tests/unit/llm/openai_test.go (expanded), tests/unit/llm/google_test.go (expanded), tests/integration/llm/provider_integration_test.go (new)
  - Summary: Created comprehensive unit tests for LLM providers, circuit breaker, retry, rate limiter, and metadata. Added 1,500+ lines of tests with table-driven patterns, HTTP mocking, edge cases (context cancellation, rate limiting, auth errors, invalid JSON, timeout handling), and integration tests.

- [x] 2.2: Create internal/config tests (0% â†’ 85%)
  - Status: âœ… Completed (2026-01-02)
  - Files: tests/unit/config/config_test.go (expanded), tests/unit/config/config_loader_test.go (expanded), tests/unit/config/defaults_test.go (new)
  - Summary: Created comprehensive unit tests for config package (1,899 total lines). Created defaults_test.go (500+ lines) testing all 26+ default constants, Default() function with all nested structures including LLM rate limiting and circuit breaker, DefaultExcludePatterns, and directory path functions. Expanded config_test.go (+400 lines) with LLM config structure tests, validation edge cases (zero/negative/boundary/large values), table-driven validation tests, and config structure validation. Expanded config_loader_test.go (+460 lines) with environment variable tests, complex config file tests, malformed YAML tests, priority order tests, directory management edge cases, config file discovery tests, validation after load, and concurrent load tests. All tests follow table-driven patterns with proper assertions and error handling.

### Phase 3: Output and Cache (Target: 75-80%)
**Estimated: 2 weeks**

- [x] 3.1: Create internal/output tests (0% â†’ 80%)
  - Status: âœ… Completed (2026-01-02)
  - Files: tests/unit/output/writer_test.go (783 lines, 20 tests), tests/unit/output/collector_test.go (831 lines, 17 tests)
  - Summary: Created comprehensive unit tests for output package (1,614 total lines, 37 test functions). Writer tests cover Write, WriteMultiple, FlushMetadata, Exists, EnsureBaseDir, Clean, Stats, GetPath with flat/nested structures. MetadataCollector tests cover Add, Flush, Count, GetIndex, IsEnabled, SetStrategy, SetSourceURL. All tests follow table-driven patterns with proper temp directory management (t.TempDir()), error handling, edge cases (nil inputs, empty content, invalid paths), concurrent access testing (goroutines with sync.WaitGroup), and JSON marshaling verification.

- [ ] 3.2: Expand internal/cache tests (0% â†’ 75%)
  - Status: Not Started
  - Files: tests/unit/cache/badger_test.go, keys_test.go, tests/integration/cache/cache_integration_test.go

### Phase 4: Fetcher and Git (Target: 70-80%)
**Estimated: 2 weeks**

- [x] 4.1: Create internal/fetcher tests (0% â†’ 70%)
  - Status: âœ… Completed (2026-01-02)
  - Files: tests/unit/fetcher/client_test.go (450+ lines, 25 tests), retry_test.go (550+ lines, 40 tests), stealth_test.go (430+ lines, 35 tests), transport_test.go (400+ lines, 25 tests), tests/integration/fetcher/fetcher_integration_test.go (400+ lines, 10 tests)
  - Summary: Created comprehensive test coverage for fetcher package (2,900+ lines, 125+ tests). Unit tests cover NewClient, Get/GetWithHeaders, HTTP status codes (200, 404, 500, 429, 502-504, 520-530), context cancellation, cookies, cache operations. Retry tests cover NewRetrier, Retry, RetryWithValue, ShouldRetryStatus, ParseRetryAfter. Stealth tests cover RandomUserAgent, RandomAcceptLanguage, StealthHeaders, RandomDelay. Transport tests cover NewStealthTransport, RoundTrip, Content-Encoding handling. Integration tests with real HTTP server cover complete workflow, retry logic, cache hit/miss, concurrent requests, timeouts. All tests follow table-driven patterns.

- [ ] 4.2: Create internal/git tests (0% â†’ 80%)
  - Status: Not Started
  - Files: tests/unit/git/client_test.go

### Phase 5: CLI and Domain (Target: 80-85%)
**Estimated: 1 week**

- [ ] 5.1: Create cmd/repodocs tests (0% â†’ 80%)
  - Status: Not Started
  - Files: cmd/repodocs/main_test.go

- [ ] 5.2: Create internal/domain tests (0% â†’ 85%)
  - Status: Not Started
  - Files: tests/unit/domain/models_test.go, errors_test.go

### Phase 6: Renderer (Target: 40-50%)
**Estimated: 2 weeks**

- [ ] 6.1: Create internal/renderer tests (0% â†’ 45%)
  - Status: Not Started
  - Files: tests/unit/renderer/detector_test.go, pool_test.go, tests/integration/renderer/renderer_integration_test.go

### Phase 7: Mock Generation and Infrastructure
**Estimated: 1 week**

- [ ] 7.1: Generate mocks for external dependencies
  - Status: Not Started
  - Files: tests/mocks/git.go, domain.go, fetcher.go, renderer.go

- [ ] 7.2: Create additional fixtures
  - Status: Not Started
  - Files: tests/testdata/fixtures/git/*.tar.gz, sitemap/*.xml, llms/*.txt

- [ ] 7.3: Update CI for coverage reporting
  - Status: Not Started
  - Files: .github/workflows/ci.yml

- [ ] 7.4: Update Makefile with new test targets
  - Status: Not Started
  - Files: Makefile

## Coverage Targets by Package

| Package | Current | Target | Status |
|---------|---------|--------|--------|
| internal/strategies | 31.0% | 85% | âš ï¸ Needs work |
| internal/converter | 0.0% | 85% | âš ï¸ Tests created, coverage verification pending |
| internal/app | 0.0% | 85% | âŒ Critical |
| internal/llm | 6.0% | 80% | âŒ Critical |
| internal/config | 0.0% | 85% | âŒ Critical |
| internal/output | 0.0% | 80% | âŒ Critical |
| internal/cache | 0.0% | 75% | âŒ Critical |
| internal/fetcher | 0.0% | 70% | âŒ High complexity |
| internal/git | 0.0% | 80% | âŒ Critical |
| cmd/repodocs | 0.0% | 80% | âŒ Critical |
| internal/domain | 0.0% | 85% | âŒ Critical |
| internal/renderer | 0.0% | 40% | âŒ Very high complexity |
| internal/utils | 94.3% | - | âœ… Complete |
| pkg/version | 100.0% | - | âœ… Complete |

## Notes

- Implementation plan created with 7 phases and 21 subtasks
- Total estimated effort: 12 weeks
- Phases prioritized by business criticality
- Hybrid testing strategy: unit tests with mocks + selected integration tests
- Adjusted thresholds for complex packages (renderer 40-50%, fetcher 70%, cache 75%)

## Next Steps

1. Start Phase 1, Subtask 1.1: Expand internal/strategies coverage
2. Run tests incrementally after each subtask
3. Generate coverage reports to verify thresholds
4. Update this file with progress

## Commands to Run

```bash
# Run unit tests (fast, with -short flag)
make test

# Run integration tests (network-dependent)
make test-integration

# Run all tests
make test-all

# Generate coverage report
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out -o coverage.html

# Check coverage per package
go test -coverprofile=coverage.out ./internal/strategies/...
go tool cover -func=coverage.out | grep internal/strategies
```
