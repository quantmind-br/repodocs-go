---
description: Go language conventions, error handling, logging standards, and CLI structure.
globs:
  - "**/*.go"
alwaysApply: false
---

# Go Language and CLI Conventions

This rule set defines the standards for Go code quality, error handling, logging, and the structure of the CLI application.

## 1. Context and Graceful Shutdown

All long-running operations must be cancellable and respect the application context.

- **Rule**: Every function that performs I/O, network requests, or long computations must accept a `context.Context` as its first argument.
- **Signal Handling**: The `cmd/repodocs/main.go` entry point must set up a signal handler to cancel the root `context.Context` upon receiving `SIGINT` or `SIGTERM`.
- **Cleanup**: Ensure that all resources (BadgerDB, Rod browser pool) are closed via `defer orchestrator.Close()` in the main `run` function, guaranteeing cleanup even on context cancellation.

## 2. Structured Logging (Zerolog)

Logging must be structured using `github.com/rs/zerolog`.

- **Pattern**: Always use the logger attached to the context: `logger.Ctx(ctx).Level().Msg(...)`.
- **Verbosity**: Use `Debug()` for detailed internal flow, `Info()` for major milestones (e.g., "Strategy detected," "File written"), and `Error()` for failures. The verbosity level is controlled by the `--verbose` flag.
- **Contextual Fields**: Include relevant fields like `url`, `strategy_type`, or `file_path` in log messages for easier debugging.

## 3. Error Handling

Errors must be wrapped to preserve the call stack and context.

- **Wrapping**: Use `fmt.Errorf("failed to execute strategy: %w", err)` to wrap errors.
- **Domain Errors**: Define all application-specific errors (e.g., `ErrUnsupportedStrategy`, `ErrContentNotFound`) in `internal/domain/errors.go`. Check for these specific errors using `errors.Is()`.
- **CLI Exit**: The `run` function in `cmd/repodocs` is the only place where errors should be printed to `os.Stderr` and result in a non-zero exit code.

## 4. CLI Structure (Cobra and Viper)

The CLI must be structured using `cobra` for commands and `viper` for configuration.

- **Configuration Binding**: All persistent flags (e.g., `--output`, `--cache-ttl`) must be bound to the `config.Config` struct using `viper.BindPFlag` within the `initConfig` function.
- **Flag Naming**: Use kebab-case for long flags (e.g., `--output-dir`).
- **Main Execution**: The core logic must reside in the `run` function's `RunE` handler, ensuring proper error propagation back to `cobra`.
